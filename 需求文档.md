## 项目背景

飞书合同模块目前需导出约 8 万条协同记录用于分析归档。但前台导出功能存在以下限制：

1. 单次最多导出 1000 条记录。
2. 只能通过 UI 手动操作导出，无法修改前台代码。
3. 导出动作完成后，飞书会向个人会话发送一条“文件准备完成”消息，需手动点击下载才能获取最终 Excel。

## 现状问题

| 问题点 | 说明 |
| --- | --- |
| 导出数量限制 | 手动导出 8 万条数据需要执行 80 次以上操作，耗时且易错。 |
| 自动化程度低 | 虽已通过 F12 获取导出接口的 curl，但仍需人工选择时间段、点击“导出”及后续下载。 |
| 时间窗口不确定 | 需根据数据量大小尝试 7 天、3 天等窗口，手工调整效率低。 |
| 文件派送机制 | 导出完成的文件通过消息发送，需点击链接才能下载，阻碍全流程自动化。 |

## 业务目标

1. 2022 年 1 月至今的协同记录全部落地到本地文件或数据库。
2. 将手工导出流程自动化或半自动化，减少人为干预次数。
3. 保证数据完整性与可追溯性，支持失败重试。

## 范围与假设

- 已获取导出接口的鉴权信息（Cookie、Headers、Body 参数等）。
- 允许在后台批量调用导出接口，但需遵守接口频控策略。
- 飞书会将导出文件以消息形式发送到指定账号的会话中，可通过开放平台 API 获取消息内容及附件。
- 无法修改飞书前台 UI，只能通过脚本或 API 实现自动化。

## 方案概述

### 1. 时间窗口切分策略

1. 以 2022-01-01 为起点，按照 7 天时间窗口生成导出任务。
2. 当单个窗口导出结果达到上限（接近 1000 条）时，自动缩小到 3 天甚至 1 天，直至满足导出限制。
3. 记录每个时间窗口的导出状态，支持失败重试与断点续跑。

### 2. 导出接口调用

1. 使用获取到的 curl 请求作为参考，转换为脚本（Python/Node/PowerShell），批量提交导出任务。
2. 统一封装请求参数（时间起止、分页、筛选条件），确保调用可配置化。
3. 处理接口返回的任务 ID 或状态码，监控导出任务完成情况。

### 3. 导出文件自动下载

1. 监听飞书机器人/开放平台消息，捕获导出完成的通知。
2. 解析通知中包含的文件 key（如 file_key、attachment_key）。
3. 调用飞书开放平台文件下载接口，将文件保存到本地指定目录。
4. 建立文件命名规范（例如 `合同协同_20220101-20220107.xlsx`）。

### 4. 数据存储与合并

1. 将各时间窗口内的 Excel 合并为总表，或直接写入数据库。
2. 对导出字段做校验（数量、字段名、空值情况）。
3. 记录日志（导出起止时间、条数、文件路径、异常信息）。

## 详细需求清单

| 模块 | 需求 | 备注 |
| --- | --- | --- |
| 配置 | 可配置时间范围、时间窗口粒度、导出筛选条件 | 支持命令行/配置文件输入 |
| 调度 | 自动遍历时间窗口并触发导出 | 支持失败重试、并发数限制 |
| 下载 | 自动识别并下载飞书消息中返回的文件 | 通过浏览器自动化访问飞书网页版并执行扫码登录、点击下载 |
| 存储 | 将导出文件按时间段归档，并支持合并 | 落地为 Excel 文件 |
| 日志/监控 | 输出导出结果统计及异常告警 | 展示导出进度、预计完成时间等信息，无需通知 |

## 技术实现要点

1. **脚本语言建议**：Python（requests + schedule）或 Node.js（axios + cron），兼容 Windows 运行环境。
2. **鉴权维护**：
   - 调用导出接口时直接携带实时抓取的 Header（示例见 curl），无需缓存或长期保存 Cookie；
   - 优先探索飞书开放平台授权方式，减少频繁抓包。
3. **接口稳定性**：加入指数退避重试、错误码分类处理。
4. **任务追踪**：针对每个时间窗口记录状态（排队中、成功、失败），落地 JSON 或数据库。
5. **文件下载**：
   - 使用 Python 自动化（如 Playwright/Selenium）打开 https://li.feishu.cn/next/messenger；
   - 扫码登录后定位机器人推送的导出完成消息；
   - 自动点击“下载文件”按钮获取 Excel；
   - 记录下载文件保存路径与命名。
6. **数据合并**：
   - 使用 pandas/Excel 库批量合并；
   - 统一字段顺序与编码；
   - 可选生成最终汇总报告。

## 交付物

1. 批量导出脚本源码及配置样例。
2. 操作手册（运行步骤、环境依赖、常见问题）。
3. 导出日志与最终合并数据文件。

## 里程碑与时间安排（建议）

| 阶段 | 内容 | 预计耗时 |
| --- | --- | --- |
| 需求确认 | 明确导出字段、接口参数与权限 | 1 天 |
| 脚本开发 | 实现时间窗口调度与导出调用 | 2-3 天 |
| 消息下载 | 完成网页版自动化脚本，实现扫码登录后批量点击下载 | 2 天 |
| 联调测试 | 全量跑通 2022 年数据，验证完整性 | 3-4 天 |
| 文档交付 | 输出操作手册与日志 | 1 天 |

## 风险与应对

| 风险 | 影响 | 应对策略 |
| --- | --- | --- |
| 接口频控或封禁 | 导出中断 | 控制并发、加入间隔、提前沟通白名单 |
| 鉴权失效 | 导出失败 | 实现 token 自动刷新或失败提示 |
| 时间窗口拆分不充分 | 数据缺失 | 记录每批条数，超限自动细分窗口 |
| 网页结构或登录机制变更 | 自动化脚本失效 | 监控页面变更，预留人工兜底方案并及时更新脚本 |
| 文件合并格式差异 | 数据错乱 | 统一字段映射与数据校验 |

## 验收标准

1. 能在无人值守情况下，批量导出并下载 2022 年至今的全部协同记录。
2. 任何时间窗口导出失败时，系统可提示并支持重试。
3. 导出日志完整记录时间窗口、条数、文件位置。
4. 汇总结果与前台抽查数据一致。
5. 提供自动化测试能力，自动校验最终导出的 Excel 文件字段完整性与数据一致性。

## 附录：接口信息整理（待补充）

| 项 | 内容 |
| --- | --- |
| 导出接口 | POST https://contract.feishu.cn/clm/api/cooperation/exportCooperationRecords<br>Headers：Timezone-Offset=-480、csrf-token=qhhu6xjd1t80、Cookie 含 session/sl_session/clm_csrf_token、Content-Type=application/json<br>Body：{"keyword":"","searchTabEnumCode":0,"searchCooperationByCreateTime":["2023-01-01","2023-12-01"]}<br>示例 curl 见下方 |
| 浏览器自动化步骤 | 通过浏览器自动化打开 https://li.feishu.cn/next/messenger，扫码登录后进入“飞书合同”机器人会话，定位最新导出完成消息并点击“下载文件” |

```bash
curl --location 'https://contract.feishu.cn/clm/api/cooperation/exportCooperationRecords' \
--header 'Timezone-Offset: -480' \
--header 'csrf-token: qhhu6xjd1t80' \
--header 'Cookie: session=XN0YXJ0-1b2m25be-c888-44b3-9004-57ea6250f2b4-WVuZA; session_list=XN0YXJ0-a87n6145-d9bc-410f-8b57-50ed4f94ed1e-WVuZA_XN0YXJ0-1b2m25be-c888-44b3-9004-57ea6250f2b4-WVuZA_XN0YXJ0-4ecq9fde-8a23-4554-8566-5ab4e4dcb336-WVuZA_XN0YXJ0-ec5pafc3-811d-4510-ad3f-7a6403001832-WVuZA;; sl_session=eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NjI5NzQxODQsInVuaXQiOiJldV9uYyIsInJhdyI6eyJtZXRhIjoiQVdqbzB3aGhUc0FjWDJyZjBzMkFnQUpvOTFVVDRnRkFBV2ozVlJQaUFVQUJhUGRWVTlmR2dBTWNLZ0VBUVVGQlFVRkJRVUZCUVVKd1JUazNVVTlSUlVGQmR6MDkiLCJzdW0iOiI1MmNjYzg3ZjZjODQyOGNmZDA0NTVhZmU1YWQ0NzU5ZGM0ODBiNWVlODY2OGM4ZWI4ZTBmMzM4Y2Q4MTBiZTg4IiwibG9jIjoiemhfY24iLCJhcGMiOiJSZWxlYXNlIiwiaWF0IjoxNzYyOTMwOTg0LCJzYWMiOnsiVXNlclN0YWZmU3RhdHVzIjoiMSIsIlVzZXJUeXBlIjoiNDIifSwibG9kIjpudWxsLCJjbmYiOnsiamt0IjoiM0FFUWxxNms0OVIyRXUxNHB5N2lFdVItQ3ZqU210MVMzZTM3QWowXzlDdyJ9LCJucyI6ImxhcmsiLCJuc191aWQiOiI3NTU5NTI0MDA3NDg3MTI3NTgwIiwibnNfdGlkIjoiNjg3NTU1Mzg3NzYxODM2MDMyMiIsIm90IjoxLCJjdCI6MTc2MjkwOTkwNCwicnQiOjE3NjI5MDk5MDR9fQ.uq9pZF50SWLisDCfULg2pUCD1-24AgevrlAWr9-aW7T7JKYdF4pKHKq1mi6LOG3mFR2E2DSj0hoNsfp4uc_5fw; clm_csrf_token=1iuvz5e5jmmnk' \
--header 'Content-Type: application/json' \
--data '{
    "keyword": "",
    "searchTabEnumCode": 0,
    "searchCooperationByCreateTime":["2023-01-01","2023-12-01"]
}'
```

1. 打开浏览器访问 https://li.feishu.cn/next/messenger，并在自动化脚本中等待扫码界面加载；
2. 用户使用移动端扫码完成登录，脚本确认进入消息列表；
3. 首次运行时搜索并进入“飞书合同”机器人会话；
4. 在该会话中定位最新的“协同操作记录导出完成”消息，触发“下载文件”按钮；
5. 记录下载完成的文件路径，供后续合并与校验使用。

> 注：实际参数、鉴权方式待结合抓包结果与开放平台文档补齐。
